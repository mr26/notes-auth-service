{{- if .Values.serviceMonitor.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "notes-service.fullname" . }}-dashboard
  namespace: observability
  labels:
    grafana_dashboard: "1"
    app: {{ include "notes-service.name" . }}
data:
  notes-service-dashboard.json: |
    {
      "annotations": { "list": [] },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "links": [],
      "panels": [
        {
          "title": "Service Health",
          "type": "stat",
          "gridPos": { "h": 6, "w": 4, "x": 0, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "mappings": [
                { "options": { "0": { "color": "red", "text": "DOWN" }, "1": { "color": "green", "text": "UP" } }, "type": "value" }
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "green", "value": 1 }
                ]
              },
              "color": { "mode": "thresholds" }
            },
            "overrides": []
          },
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "center",
            "textMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }
          },
          "targets": [
            {
              "expr": "up{job=\"prod-release1\"}",
              "legendFormat": "notes-service",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Uptime",
          "type": "stat",
          "gridPos": { "h": 6, "w": 4, "x": 4, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "orange", "value": 3600 },
                  { "color": "green", "value": 86400 }
                ]
              },
              "color": { "mode": "thresholds" }
            },
            "overrides": []
          },
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "center",
            "textMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }
          },
          "targets": [
            {
              "expr": "time() - process_start_time_seconds{job=\"prod-release1\"}",
              "legendFormat": "uptime",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Total Requests",
          "type": "stat",
          "gridPos": { "h": 6, "w": 4, "x": 8, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "blue", "value": null }]
              },
              "color": { "mode": "thresholds" }
            },
            "overrides": []
          },
          "options": {
            "colorMode": "background",
            "graphMode": "area",
            "justifyMode": "center",
            "textMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }
          },
          "targets": [
            {
              "expr": "sum(http_requests_total{job=\"prod-release1\"})",
              "legendFormat": "total",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Error Rate (%)",
          "type": "stat",
          "gridPos": { "h": 6, "w": 4, "x": 12, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "percentunit",
              "decimals": 2,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.01 },
                  { "color": "red", "value": 0.05 }
                ]
              },
              "color": { "mode": "thresholds" },
              "min": 0,
              "max": 1
            },
            "overrides": []
          },
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "center",
            "textMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }
          },
          "targets": [
            {
              "expr": "sum(rate(http_requests_total{job=\"prod-release1\", status=~\"5xx|4xx\"}[5m])) / sum(rate(http_requests_total{job=\"prod-release1\"}[5m])) or vector(0)",
              "legendFormat": "error rate",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Avg Latency",
          "type": "stat",
          "gridPos": { "h": 6, "w": 4, "x": 16, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "decimals": 3,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.5 },
                  { "color": "red", "value": 1 }
                ]
              },
              "color": { "mode": "thresholds" }
            },
            "overrides": []
          },
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "center",
            "textMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }
          },
          "targets": [
            {
              "expr": "sum(rate(http_request_duration_seconds_sum{job=\"prod-release1\"}[5m])) / sum(rate(http_request_duration_seconds_count{job=\"prod-release1\"}[5m]))",
              "legendFormat": "avg latency",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Request Rate by Endpoint",
          "description": "Requests per second broken down by handler and status",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 7 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "custom": {
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "fillOpacity": 20,
                "pointSize": 5,
                "showPoints": "auto"
              },
              "unit": "reqps"
            },
            "overrides": []
          },
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] },
            "tooltip": { "mode": "multi" }
          },
          "targets": [
            {
              "expr": "sum by (handler, method) (rate(http_requests_total{job=\"prod-release1\"}[5m]))",
              "legendFormat": "{{ "{{" }}method{{ "}}" }} {{ "{{" }}handler{{ "}}" }}",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Error Rate by Endpoint",
          "description": "4xx and 5xx errors per second by handler",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 7 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "custom": {
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "fillOpacity": 20,
                "pointSize": 5,
                "showPoints": "auto"
              },
              "unit": "reqps",
              "color": { "mode": "palette-classic" }
            },
            "overrides": []
          },
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] },
            "tooltip": { "mode": "multi" }
          },
          "targets": [
            {
              "expr": "sum by (handler, status) (rate(http_requests_total{job=\"prod-release1\", status=~\"4xx|5xx\"}[5m]))",
              "legendFormat": "{{ "{{" }}handler{{ "}}" }} {{ "{{" }}status{{ "}}" }}",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Request Latency (p50 / p95 / p99)",
          "description": "Response time percentiles",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 15 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "custom": {
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "fillOpacity": 10,
                "pointSize": 5,
                "showPoints": "auto"
              },
              "unit": "s"
            },
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "p99" },
                "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }]
              },
              {
                "matcher": { "id": "byName", "options": "p95" },
                "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }]
              },
              {
                "matcher": { "id": "byName", "options": "p50" },
                "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }]
              }
            ]
          },
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] },
            "tooltip": { "mode": "multi" }
          },
          "targets": [
            {
              "expr": "histogram_quantile(0.50, sum by (le) (rate(http_request_duration_highr_seconds_bucket{job=\"prod-release1\"}[5m])))",
              "legendFormat": "p50",
              "refId": "A"
            },
            {
              "expr": "histogram_quantile(0.95, sum by (le) (rate(http_request_duration_highr_seconds_bucket{job=\"prod-release1\"}[5m])))",
              "legendFormat": "p95",
              "refId": "B"
            },
            {
              "expr": "histogram_quantile(0.99, sum by (le) (rate(http_request_duration_highr_seconds_bucket{job=\"prod-release1\"}[5m])))",
              "legendFormat": "p99",
              "refId": "C"
            }
          ]
        },
        {
          "title": "Latency by Endpoint",
          "description": "Average latency per handler",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 15 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "custom": {
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "fillOpacity": 10,
                "pointSize": 5,
                "showPoints": "auto"
              },
              "unit": "s"
            },
            "overrides": []
          },
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] },
            "tooltip": { "mode": "multi" }
          },
          "targets": [
            {
              "expr": "sum by (handler) (rate(http_request_duration_seconds_sum{job=\"prod-release1\"}[5m])) / sum by (handler) (rate(http_request_duration_seconds_count{job=\"prod-release1\"}[5m]))",
              "legendFormat": "{{ "{{" }}handler{{ "}}" }}",
              "refId": "A"
            }
          ]
        },
        {
          "title": "CPU Usage",
          "description": "CPU seconds consumed per second",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 8, "x": 0, "y": 23 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "custom": {
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "fillOpacity": 30,
                "gradientMode": "scheme"
              },
              "unit": "percentunit",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.7 },
                  { "color": "red", "value": 0.9 }
                ]
              },
              "color": { "mode": "continuous-GrYlRd" }
            },
            "overrides": []
          },
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom" },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "rate(process_cpu_seconds_total{job=\"prod-release1\"}[5m])",
              "legendFormat": "CPU usage",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Memory Usage",
          "description": "Resident memory (RSS) of the process",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 8, "x": 8, "y": 23 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "custom": {
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "fillOpacity": 30,
                "gradientMode": "scheme"
              },
              "unit": "bytes",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 268435456 },
                  { "color": "red", "value": 536870912 }
                ]
              },
              "color": { "mode": "continuous-GrYlRd" }
            },
            "overrides": []
          },
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom" },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "process_resident_memory_bytes{job=\"prod-release1\"}",
              "legendFormat": "RSS memory",
              "refId": "A"
            }
          ]
        },
        {
          "title": "Open File Descriptors",
          "description": "File descriptor usage vs max",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 8, "x": 16, "y": 23 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "custom": {
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "fillOpacity": 20
              }
            },
            "overrides": []
          },
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom" },
            "tooltip": { "mode": "multi" }
          },
          "targets": [
            {
              "expr": "process_open_fds{job=\"prod-release1\"}",
              "legendFormat": "open FDs",
              "refId": "A"
            },
            {
              "expr": "process_max_fds{job=\"prod-release1\"}",
              "legendFormat": "max FDs",
              "refId": "B"
            }
          ]
        }
      ],
      "schemaVersion": 39,
      "tags": ["notes-service", "golden-signals"],
      "templating": { "list": [] },
      "time": { "from": "now-1h", "to": "now" },
      "title": "Notes Service - Golden Signals",
      "uid": "notes-service-golden-signals",
      "version": 1
    }
{{- end }}
